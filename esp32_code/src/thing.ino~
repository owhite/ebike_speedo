#include <ArduinoJson.h>

// #include "BluetoothSerial.h"

// #if !defined(CONFIG_BT_ENABLED) || !defined(CONFIG_BLUEDROID_ENABLED)
// #error Bluetooth is not enabled! Please run `make menuconfig` to and enable it
// #endif

// BluetoothSerial SerialBT;

char inChar;
char oldChar;
char inStr[100] = "";
int count = 0;

void setup() {
  Serial.begin(9600);
  Serial1.begin(9600);
  // SerialBT.begin("ESP32test"); //Bluetooth device name

  Serial.println("The device started, now you can pair it with bluetooth!");
  pinMode(13, OUTPUT);

}


void loop() {
  if (Serial1.available()) {
    inChar = Serial1.read();
    if (inChar == '\n' && oldChar == '\r') {
      inStr[count - 1] = '\0';
      Serial.println(inStr);

      StaticJsonDocument<200> doc;

      DeserializationError error = deserializeJson(doc, inStr);
      if (error) {
	Serial.print(F("deserializeJson() failed: "));
	Serial.println(error.f_str());
      }
      else {
	uint16_t amps = doc["amps"];
	uint16_t volts = doc["volts"];
	Serial.println(amps);
	Serial.println(volts);
      }

      count = 0;
    }
    else {
      inStr[count] = inChar;
      count++;
    }
    // Serial.write(inChar);
    oldChar = inChar;
    // SerialBT.write(Serial.read());
  }
}
